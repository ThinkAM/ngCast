import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
let NgCastService = class NgCastService {
    constructor() {
        this.window = window;
        this.status = {
            casting: false
        };
        this.onInitSuccess = function () {
            console.log('GCast initialization success');
        };
        this.onError = function (err) {
            console.log('GCast initialization failed', err);
        };
        this.discoverDevices = () => {
            let self = this;
            let subj = new Subject();
            this.cast.requestSession((s) => {
                self.session = s;
                self.setCasting(true);
                subj.next('CONNECTED');
            }, function (err) {
                self.setCasting(false);
                if (err.code === 'cancel') {
                    self.session = undefined;
                    subj.next('CANCEL');
                }
                else {
                    console.error('Error selecting a cast device', err);
                }
            });
            return subj;
        };
        this.launchMedia = (media) => {
            let mediaInfo = new this.cast.media.MediaInfo(media);
            let request = new this.cast.media.LoadRequest(mediaInfo);
            console.log('launch media with session', this.session);
            if (!this.session) {
                window.open(media);
                return false;
            }
            this.session.loadMedia(request, this.onMediaDiscovered.bind(this, 'loadMedia'), this.onMediaError);
            return true;
        };
        this.onMediaDiscovered = (url, type) => {
            if (this.window.__onGCastApiAvailable) {
                this.cast = this.window['chrome'].cast;
                this.chrome = this.window['chrome'];
                var castContext = this.cast.framework.CastContext.getInstance();
                castContext.setOptions({
                    autoJoinPolicy: this.chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,
                    receiverApplicationId: this.chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID
                });
                var stateChanged = this.cast.framework.CastContextEventType.CAST_STATE_CHANGED;
                castContext.addEventListener(stateChanged, () => {
                    var castSession = castContext.getCurrentSession();
                    var media = new this.chrome.cast.media.MediaInfo(url, type);
                    var request = new this.chrome.cast.media.LoadRequest(media);
                    castSession && castSession
                        .loadMedia(request)
                        .then(() => {
                        console.log('Success');
                    })
                        .catch((error) => {
                        console.log('Error: ' + error);
                    });
                    this.currentMedia = media;
                });
            }
            else {
                setInterval(() => {
                    this.onMediaDiscovered(url, type);
                }, 500);
            }
        };
        this.play = () => {
            this.currentMedia.play(null);
        };
        this.pause = () => {
            this.currentMedia.pause(null);
        };
        this.stop = () => {
            this.currentMedia.stop(null);
        };
        this.onMediaError = (err) => {
            console.error('Error launching media', err);
        };
    }
    initializeCastApi() {
        this.cast = this.window['chrome'].cast;
        let sessionRequest = new this.cast.SessionRequest(this.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID);
        let apiConfig = new this.cast.ApiConfig(sessionRequest, () => { }, (status) => { if (status === this.cast.ReceiverAvailability.AVAILABLE) { } });
        let x = this.cast.initialize(apiConfig, this.onInitSuccess, this.onError);
    }
    ;
    onGCastApiAvailable(url, type) {
        this.window.__onGCastApiAvailable = (isAvailable) => {
            if (!isAvailable) {
                return false;
            }
            this.cast = this.window['chrome'].cast;
            this.chrome = this.window['chrome'];
            var castContext = this.cast.framework.CastContext.getInstance();
            castContext.setOptions({
                autoJoinPolicy: this.chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,
                receiverApplicationId: this.chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID
            });
            var stateChanged = this.cast.framework.CastContextEventType.CAST_STATE_CHANGED;
            castContext.addEventListener(stateChanged, () => {
                var castSession = castContext.getCurrentSession();
                var media = new this.chrome.cast.media.MediaInfo(url, type);
                var request = new this.chrome.cast.media.LoadRequest(media);
                castSession && castSession
                    .loadMedia(request)
                    .then(() => {
                    console.log('Success');
                })
                    .catch((error) => {
                    console.log('Error: ' + error);
                });
            });
        };
    }
    setCasting(value) {
        this.status.casting = value;
    }
    getStatus() {
        return this.status;
    }
};
NgCastService = tslib_1.__decorate([
    Injectable()
], NgCastService);
export { NgCastService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctY2FzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RoaW5rZXIvZGV2L3RoaW5rYW0vbmdDYXN0LyIsInNvdXJjZXMiOlsic2hhcmVkL25nLWNhc3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRy9CLElBQWEsYUFBYSxHQUExQixNQUFhLGFBQWE7SUFVeEI7UUFMUSxXQUFNLEdBQVEsTUFBTSxDQUFDO1FBQ3RCLFdBQU0sR0FBRztZQUNkLE9BQU8sRUFBRSxLQUFLO1NBQ2YsQ0FBQztRQWdERixrQkFBYSxHQUFHO1lBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBQzlDLENBQUMsQ0FBQztRQUVGLFlBQU8sR0FBRyxVQUFVLEdBQVE7WUFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUM7UUFFRixvQkFBZSxHQUFHLEdBQUcsRUFBRTtZQUNyQixJQUFJLElBQUksR0FBUSxJQUFJLENBQUM7WUFDckIsSUFBSSxJQUFJLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQU0sRUFBRSxFQUFFO2dCQUNsQyxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQztnQkFDakIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN6QixDQUFDLEVBQUUsVUFBVSxHQUFRO2dCQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN2QixJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFO29CQUN6QixJQUFJLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQztvQkFDekIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDckI7cUJBQU07b0JBQ0wsT0FBTyxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRSxHQUFHLENBQUMsQ0FBQztpQkFDckQ7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUNILE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxDQUFDO1FBRUYsZ0JBQVcsR0FBRyxDQUFDLEtBQVUsRUFBRSxFQUFFO1lBQzNCLElBQUksU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3JELElBQUksT0FBTyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3pELE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRXZELElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUNqQixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQixPQUFPLEtBQUssQ0FBQzthQUNkO1lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNuRyxPQUFPLElBQUksQ0FBQztRQUNkLENBQUMsQ0FBQztRQUVGLHNCQUFpQixHQUFHLENBQUMsR0FBVyxFQUFFLElBQVksRUFBRSxFQUFFO1lBQ2hELElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRTtnQkFDckMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDdkMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUVwQyxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBRWhFLFdBQVcsQ0FBQyxVQUFVLENBQUM7b0JBQ25CLGNBQWMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYTtvQkFDN0QscUJBQXFCLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLDZCQUE2QjtpQkFDOUUsQ0FBQyxDQUFDO2dCQUVILElBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLG9CQUFvQixDQUFDLGtCQUFrQixDQUFDO2dCQUM3RSxXQUFXLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtvQkFDNUMsSUFBSSxXQUFXLEdBQUcsV0FBVyxDQUFDLGlCQUFpQixFQUFFLENBQUM7b0JBQ2xELElBQUksS0FBSyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7b0JBQzVELElBQUksT0FBTyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFFNUQsV0FBVyxJQUFJLFdBQVc7eUJBQ3JCLFNBQVMsQ0FBQyxPQUFPLENBQUM7eUJBQ2xCLElBQUksQ0FBQyxHQUFHLEVBQUU7d0JBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDM0IsQ0FBQyxDQUFDO3lCQUNELEtBQUssQ0FBQyxDQUFDLEtBQVUsRUFBRSxFQUFFO3dCQUNsQixPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsQ0FBQztvQkFDbkMsQ0FBQyxDQUFDLENBQUM7b0JBRVAsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7Z0JBQzlCLENBQUMsQ0FBQyxDQUFDO2FBQ047aUJBQU07Z0JBQ0wsV0FBVyxDQUFDLEdBQUcsRUFBRTtvQkFDZixJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNwQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDVDtRQUNILENBQUMsQ0FBQztRQUVGLFNBQUksR0FBRyxHQUFHLEVBQUU7WUFDVixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQixDQUFDLENBQUM7UUFFRixVQUFLLEdBQUcsR0FBRyxFQUFFO1lBQ1gsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEMsQ0FBQyxDQUFDO1FBRUYsU0FBSSxHQUFHLEdBQUcsRUFBRTtZQUNWLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9CLENBQUMsQ0FBQztRQUVGLGlCQUFZLEdBQUcsQ0FBQyxHQUFRLEVBQUUsRUFBRTtZQUMxQixPQUFPLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzlDLENBQUMsQ0FBQztJQXhJYSxDQUFDO0lBRWhCLGlCQUFpQjtRQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDdkMsSUFBSSxjQUFjLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO1FBQ2pHLElBQUksU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUNwRCxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQ1QsQ0FBQyxNQUFXLEVBQUUsRUFBRSxHQUFHLElBQUksTUFBTSxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQ2xGLENBQUM7UUFDRixJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUFBLENBQUM7SUFFRixtQkFBbUIsQ0FBQyxHQUFXLEVBQUUsSUFBWTtRQUMzQyxJQUFJLENBQUMsTUFBTSxDQUFDLHFCQUFxQixHQUFHLENBQUMsV0FBb0IsRUFBRSxFQUFFO1lBQzNELElBQUcsQ0FBQyxXQUFXLEVBQUM7Z0JBQ1osT0FBTyxLQUFLLENBQUM7YUFDaEI7WUFFRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUVwQyxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFaEUsV0FBVyxDQUFDLFVBQVUsQ0FBQztnQkFDbkIsY0FBYyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhO2dCQUM3RCxxQkFBcUIsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsNkJBQTZCO2FBQzlFLENBQUMsQ0FBQztZQUVILElBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLG9CQUFvQixDQUFDLGtCQUFrQixDQUFDO1lBQy9FLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFO2dCQUM1QyxJQUFJLFdBQVcsR0FBRyxXQUFXLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztnQkFDbEQsSUFBSSxLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDNUQsSUFBSSxPQUFPLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUU1RCxXQUFXLElBQUksV0FBVztxQkFDckIsU0FBUyxDQUFDLE9BQU8sQ0FBQztxQkFDbEIsSUFBSSxDQUFDLEdBQUcsRUFBRTtvQkFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUMzQixDQUFDLENBQUM7cUJBQ0QsS0FBSyxDQUFDLENBQUMsS0FBVSxFQUFFLEVBQUU7b0JBQ2xCLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDO2dCQUNuQyxDQUFDLENBQUMsQ0FBQztZQUNYLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQThGRCxVQUFVLENBQUMsS0FBVTtRQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUVELFNBQVM7UUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUE7SUFDcEIsQ0FBQztDQUNGLENBQUE7QUEzSlksYUFBYTtJQUR6QixVQUFVLEVBQUU7R0FDQSxhQUFhLENBMkp6QjtTQTNKWSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOZ0Nhc3RTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBjYXN0OiBhbnk7XG4gIHByaXZhdGUgY2hyb21lOiBhbnk7XG4gIHByaXZhdGUgc2Vzc2lvbjogYW55O1xuICBwcml2YXRlIGN1cnJlbnRNZWRpYTogYW55O1xuICBwcml2YXRlIHdpbmRvdzogYW55ID0gd2luZG93O1xuICBwdWJsaWMgc3RhdHVzID0ge1xuICAgIGNhc3Rpbmc6IGZhbHNlXG4gIH07XG5cbiAgY29uc3RydWN0b3IoKSB7fVxuXG4gIGluaXRpYWxpemVDYXN0QXBpKCkge1xuICAgIHRoaXMuY2FzdCA9IHRoaXMud2luZG93WydjaHJvbWUnXS5jYXN0O1xuICAgIGxldCBzZXNzaW9uUmVxdWVzdCA9IG5ldyB0aGlzLmNhc3QuU2Vzc2lvblJlcXVlc3QodGhpcy5jYXN0Lm1lZGlhLkRFRkFVTFRfTUVESUFfUkVDRUlWRVJfQVBQX0lEKTtcbiAgICBsZXQgYXBpQ29uZmlnID0gbmV3IHRoaXMuY2FzdC5BcGlDb25maWcoc2Vzc2lvblJlcXVlc3QsXG4gICAgICAoKSA9PiB7IH0sXG4gICAgICAoc3RhdHVzOiBhbnkpID0+IHsgaWYgKHN0YXR1cyA9PT0gdGhpcy5jYXN0LlJlY2VpdmVyQXZhaWxhYmlsaXR5LkFWQUlMQUJMRSkgeyB9IH1cbiAgICApO1xuICAgIGxldCB4ID0gdGhpcy5jYXN0LmluaXRpYWxpemUoYXBpQ29uZmlnLCB0aGlzLm9uSW5pdFN1Y2Nlc3MsIHRoaXMub25FcnJvcik7XG4gIH07XG5cbiAgb25HQ2FzdEFwaUF2YWlsYWJsZSh1cmw6IHN0cmluZywgdHlwZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy53aW5kb3cuX19vbkdDYXN0QXBpQXZhaWxhYmxlID0gKGlzQXZhaWxhYmxlOiBib29sZWFuKSA9PiB7XG4gICAgICBpZighaXNBdmFpbGFibGUpe1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgdGhpcy5jYXN0ID0gdGhpcy53aW5kb3dbJ2Nocm9tZSddLmNhc3Q7XG4gICAgICB0aGlzLmNocm9tZSA9IHRoaXMud2luZG93WydjaHJvbWUnXTtcblxuICAgICAgdmFyIGNhc3RDb250ZXh0ID0gdGhpcy5jYXN0LmZyYW1ld29yay5DYXN0Q29udGV4dC5nZXRJbnN0YW5jZSgpO1xuICBcbiAgICAgIGNhc3RDb250ZXh0LnNldE9wdGlvbnMoe1xuICAgICAgICAgIGF1dG9Kb2luUG9saWN5OiB0aGlzLmNocm9tZS5jYXN0LkF1dG9Kb2luUG9saWN5Lk9SSUdJTl9TQ09QRUQsXG4gICAgICAgICAgcmVjZWl2ZXJBcHBsaWNhdGlvbklkOiB0aGlzLmNocm9tZS5jYXN0Lm1lZGlhLkRFRkFVTFRfTUVESUFfUkVDRUlWRVJfQVBQX0lEXG4gICAgICB9KTtcbiAgXG4gICAgICB2YXIgc3RhdGVDaGFuZ2VkID0gdGhpcy5jYXN0LmZyYW1ld29yay5DYXN0Q29udGV4dEV2ZW50VHlwZS5DQVNUX1NUQVRFX0NIQU5HRUQ7XG4gICAgICBjYXN0Q29udGV4dC5hZGRFdmVudExpc3RlbmVyKHN0YXRlQ2hhbmdlZCwgKCkgPT4ge1xuICAgICAgICAgIHZhciBjYXN0U2Vzc2lvbiA9IGNhc3RDb250ZXh0LmdldEN1cnJlbnRTZXNzaW9uKCk7XG4gICAgICAgICAgdmFyIG1lZGlhID0gbmV3IHRoaXMuY2hyb21lLmNhc3QubWVkaWEuTWVkaWFJbmZvKHVybCwgdHlwZSk7XG4gICAgICAgICAgdmFyIHJlcXVlc3QgPSBuZXcgdGhpcy5jaHJvbWUuY2FzdC5tZWRpYS5Mb2FkUmVxdWVzdChtZWRpYSk7XG4gIFxuICAgICAgICAgIGNhc3RTZXNzaW9uICYmIGNhc3RTZXNzaW9uXG4gICAgICAgICAgICAgIC5sb2FkTWVkaWEocmVxdWVzdClcbiAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1N1Y2Nlc3MnKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3I6ICcgKyBlcnJvcik7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfTtcbiAgfVxuXG4gIG9uSW5pdFN1Y2Nlc3MgPSBmdW5jdGlvbiAoKSB7XG4gICAgY29uc29sZS5sb2coJ0dDYXN0IGluaXRpYWxpemF0aW9uIHN1Y2Nlc3MnKTtcbiAgfTtcblxuICBvbkVycm9yID0gZnVuY3Rpb24gKGVycjogYW55KSB7XG4gICAgY29uc29sZS5sb2coJ0dDYXN0IGluaXRpYWxpemF0aW9uIGZhaWxlZCcsIGVycik7XG4gIH07XG5cbiAgZGlzY292ZXJEZXZpY2VzID0gKCkgPT4ge1xuICAgIGxldCBzZWxmOiBhbnkgPSB0aGlzO1xuICAgIGxldCBzdWJqID0gbmV3IFN1YmplY3QoKTtcbiAgICB0aGlzLmNhc3QucmVxdWVzdFNlc3Npb24oKHM6IGFueSkgPT4ge1xuICAgICAgc2VsZi5zZXNzaW9uID0gcztcbiAgICAgIHNlbGYuc2V0Q2FzdGluZyh0cnVlKTtcbiAgICAgIHN1YmoubmV4dCgnQ09OTkVDVEVEJyk7XG4gICAgfSwgZnVuY3Rpb24gKGVycjogYW55KSB7XG4gICAgICBzZWxmLnNldENhc3RpbmcoZmFsc2UpO1xuICAgICAgaWYgKGVyci5jb2RlID09PSAnY2FuY2VsJykge1xuICAgICAgICBzZWxmLnNlc3Npb24gPSB1bmRlZmluZWQ7XG4gICAgICAgIHN1YmoubmV4dCgnQ0FOQ0VMJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBzZWxlY3RpbmcgYSBjYXN0IGRldmljZScsIGVycik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHN1Ymo7XG4gIH07XG5cbiAgbGF1bmNoTWVkaWEgPSAobWVkaWE6IGFueSkgPT4gIHtcbiAgICBsZXQgbWVkaWFJbmZvID0gbmV3IHRoaXMuY2FzdC5tZWRpYS5NZWRpYUluZm8obWVkaWEpO1xuICAgIGxldCByZXF1ZXN0ID0gbmV3IHRoaXMuY2FzdC5tZWRpYS5Mb2FkUmVxdWVzdChtZWRpYUluZm8pO1xuICAgIGNvbnNvbGUubG9nKCdsYXVuY2ggbWVkaWEgd2l0aCBzZXNzaW9uJywgdGhpcy5zZXNzaW9uKTtcblxuICAgIGlmICghdGhpcy5zZXNzaW9uKSB7XG4gICAgICB3aW5kb3cub3BlbihtZWRpYSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMuc2Vzc2lvbi5sb2FkTWVkaWEocmVxdWVzdCwgdGhpcy5vbk1lZGlhRGlzY292ZXJlZC5iaW5kKHRoaXMsICdsb2FkTWVkaWEnKSwgdGhpcy5vbk1lZGlhRXJyb3IpO1xuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIG9uTWVkaWFEaXNjb3ZlcmVkID0gKHVybDogc3RyaW5nLCB0eXBlOiBzdHJpbmcpID0+IHtcbiAgICBpZiAodGhpcy53aW5kb3cuX19vbkdDYXN0QXBpQXZhaWxhYmxlKSB7XG4gICAgICB0aGlzLmNhc3QgPSB0aGlzLndpbmRvd1snY2hyb21lJ10uY2FzdDtcbiAgICAgIHRoaXMuY2hyb21lID0gdGhpcy53aW5kb3dbJ2Nocm9tZSddO1xuXG4gICAgICB2YXIgY2FzdENvbnRleHQgPSB0aGlzLmNhc3QuZnJhbWV3b3JrLkNhc3RDb250ZXh0LmdldEluc3RhbmNlKCk7XG4gIFxuICAgICAgY2FzdENvbnRleHQuc2V0T3B0aW9ucyh7XG4gICAgICAgICAgYXV0b0pvaW5Qb2xpY3k6IHRoaXMuY2hyb21lLmNhc3QuQXV0b0pvaW5Qb2xpY3kuT1JJR0lOX1NDT1BFRCxcbiAgICAgICAgICByZWNlaXZlckFwcGxpY2F0aW9uSWQ6IHRoaXMuY2hyb21lLmNhc3QubWVkaWEuREVGQVVMVF9NRURJQV9SRUNFSVZFUl9BUFBfSURcbiAgICAgIH0pO1xuXG4gICAgICB2YXIgc3RhdGVDaGFuZ2VkID0gdGhpcy5jYXN0LmZyYW1ld29yay5DYXN0Q29udGV4dEV2ZW50VHlwZS5DQVNUX1NUQVRFX0NIQU5HRUQ7XG4gICAgICAgIGNhc3RDb250ZXh0LmFkZEV2ZW50TGlzdGVuZXIoc3RhdGVDaGFuZ2VkLCAoKSA9PiB7XG4gICAgICAgICAgICB2YXIgY2FzdFNlc3Npb24gPSBjYXN0Q29udGV4dC5nZXRDdXJyZW50U2Vzc2lvbigpO1xuICAgICAgICAgICAgdmFyIG1lZGlhID0gbmV3IHRoaXMuY2hyb21lLmNhc3QubWVkaWEuTWVkaWFJbmZvKHVybCwgdHlwZSk7XG4gICAgICAgICAgICB2YXIgcmVxdWVzdCA9IG5ldyB0aGlzLmNocm9tZS5jYXN0Lm1lZGlhLkxvYWRSZXF1ZXN0KG1lZGlhKTtcbiAgICBcbiAgICAgICAgICAgIGNhc3RTZXNzaW9uICYmIGNhc3RTZXNzaW9uXG4gICAgICAgICAgICAgICAgLmxvYWRNZWRpYShyZXF1ZXN0KVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1N1Y2Nlc3MnKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3I6ICcgKyBlcnJvcik7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuY3VycmVudE1lZGlhID0gbWVkaWE7XG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgIHRoaXMub25NZWRpYURpc2NvdmVyZWQodXJsLCB0eXBlKTtcbiAgICAgIH0sIDUwMCk7XG4gICAgfSAgICBcbiAgfTtcblxuICBwbGF5ID0gKCkgPT4ge1xuICAgIHRoaXMuY3VycmVudE1lZGlhLnBsYXkobnVsbCk7XG4gIH07XG5cbiAgcGF1c2UgPSAoKSA9PiB7XG4gICAgdGhpcy5jdXJyZW50TWVkaWEucGF1c2UobnVsbCk7XG4gIH07XG5cbiAgc3RvcCA9ICgpID0+IHtcbiAgICB0aGlzLmN1cnJlbnRNZWRpYS5zdG9wKG51bGwpO1xuICB9O1xuXG4gIG9uTWVkaWFFcnJvciA9IChlcnI6IGFueSkgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGxhdW5jaGluZyBtZWRpYScsIGVycik7XG4gIH07XG5cbiAgc2V0Q2FzdGluZyh2YWx1ZTogYW55KSB7XG4gICAgdGhpcy5zdGF0dXMuY2FzdGluZyA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0U3RhdHVzKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXR1c1xuICB9XG59XG4iXX0=